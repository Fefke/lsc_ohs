<?xml version="1.0" encoding="utf-8"?>
<modification
	xmlns="https://github.com/vqmod/vqmod"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="https://github.com/vqmod/vqmod https://raw.githubusercontent.com/vqmod/vqmod/master/vqmod.xsd">
	
	<id>Order History Summary</id>
	<version>1.1</version>
	<vqmver required="false">2.X</vqmver>
	<author>beetdev™</author>
	
	
	<file name="pages/order_history.inc.php">
		<operation error="log" info="Add required data structures">
			<search position="replace">
				<![CDATA[
					$_page->snippets['orders'][]
				]]>
			</search>
			<add>
				<![CDATA[
					// Hole alle Infos nach Bestellungs ID
					$orderx 	= new ctrl_order($order['id']);
					$items 		= (isset($orderx->data['items'])) ? $orderx->data['items'] : [];
					$tracking_id 	= (isset($orderx->data['shipping_tracking_id'])) ? $orderx->data['shipping_tracking_id'] : '';
					$order_totals = array_slice($orderx->data['order_total'], 1);// Hole alles außer Zwischensumme (1.)

					//echo "<pre>" . print_r($order_totals, true) . "</pre>";
					//exit;
					
					//Preset Vars
					$payment_fee = 0;
					$shipping_fee = 0;
					$fees = 0;
					
					foreach ($order_totals as $value) {
						if (strpos($value["module_id"], 'payment') !== false) {
							$subval = (double) (isset($value["value"])) ? $value["value"] : 0; 
							$tax 	= (double) (isset($value["tax"])) ? $value["tax"] : 0; 
							$payment_fee 	+= $subval + $tax;
							
						} else if (strpos($value["module_id"], 'shipping') !== false) {
							$subval = (double) (isset($value["value"])) ? $value["value"] : 0; 
							$tax 	= (double) (isset($value["tax"])) ? $value["tax"] : 0; 
							$shipping_fee 	+= $subval + $tax;
							
						} else {
							$subval = (double) (isset($value["value"])) ? $value["value"] : 0; 
							$tax 	= (double) (isset($value["tax"])) ? $value["tax"] : 0; 
							$fees 			+= $subval + $tax;
						}						
					}
						
					$_page->snippets['orders'][]
				]]>
			</add>
		</operation>

		<operation error="log" info="Add values to array => for usage with template">
			<search position="after">
				<![CDATA[
					'payment_due' => currency::format($order['payment_due'], false, $order['currency_code'], $order['currency_value']),
				]]>
			</search>
			<add>
				<![CDATA[
					'description' => '',
					'items' => $items,
					'payment_fee' => $payment_fee,
					'shipping_fee' => $shipping_fee,
					'fees' => $fees,
					'tracking_id' => $tracking_id,
				]]>
			</add>
		</operation>
	</file>
	
	<!-- INTEGRATION for default TEMPLATE -->
	<!-- Own template? Same order_history file? try:
		<file name="includes/templates/YOUR_TEMPALTEs_NAME/pages/order_history.inc.php">
		
		It will also work!
	-->
	<file name="includes/templates/default.catalog/pages/order_history.inc.php">
		<operation error="log" info="Add the support button">
			<search position="replace">
				<![CDATA[
					<td class="text-right"><a href="<?php echo htmlspecialchars($order['link']); ?>" target="_blank"><?php echo functions::draw_fonticon('fa-print'); ?></a></td>
				]]>
			</search>
			<add>
				<![CDATA[
					<td class="text-right">
						<a href="<?php echo htmlspecialchars($order['link']); ?>" target="_blank"><?php echo functions::draw_fonticon('fa-print'); ?></a>
						<a href="mailto:<?php echo settings::get('store_email'); ?>" target="_blank"><?php echo functions::draw_fonticon('fa-support'); ?></a>
					</td>
				]]>
			</add>
		</operation>


		<operation error="log" info="Add default style - comment if not needed -">
			<search position="after">
				<![CDATA[
					</table>
				]]>
			</search>
			<add>
				<![CDATA[
					
					<style>
						/*DETAILs*/
						
						details summary {
								padding-left: 15px;
						}
						
						/*TABLE*/
						#ArticleOHistory {
							border: 1px solid black;
						}
						
						#ArticleOHistory tr {
							border-bottom: 1px solid black;
							line-height: 50px;
						}
						
						#ArticleOHistory td, #ArticleOHistory th  {
							border-right: 1px solid black;
						}
					
						#ArticleOHistory tr:nth-last-child(2) {
							border-bottom: 1px solid black;
						}
						
						#ArticleOHistory tr:nth-last-child(2) td:last-of-type {
							border-bottom: 3px solid black;
						}
					
						#finalArticleOHistory1 td, #finalArticleOHistory2 td {
							border-right: none;
						} 
						
						#finalArticleOHistory1 td:nth-last-child(2),
						#finalArticleOHistory2 td:nth-last-child(2) {
							border-right: 1px solid black;
						}
						
						#finalArticleOHistory1 td:nth-last-child(2),
						#finalArticleOHistory2 td:nth-last-child(2),
						#finalArticleOHistory2 td:first-of-type {
							text-align: right;
						}
					
					</style>
				]]>
			</add>
		</operation>


		<operation error="log" info="Dynamic Detail > Table">
			<search position="before">
				<![CDATA[
					<?php } ?>
				]]>
			</search>
			<add>
				<![CDATA[
					<tr>
						<td colspan="5">
							<details <?php if (!isset($firstRound) || $firstRound == true) echo "open";?>>
								<summary><?php echo language::translate('title_products','Products'); ?></summary>
								<table id="ArticleOHistory" class="table table-striped table-hover data-table">
									<thead>
										<tr>
											<th><?php echo language::translate('title_quantity','Quantity'); ?></th>
											<th><?php echo language::translate('title_sku','SKU'); ?></th>
											<th><?php echo language::translate('title_short_description','Short Description'); ?></th>
											<th><?php echo language::translate('title_unit_price','Unit Price'); ?></th>
											<th><?php echo language::translate('title_total','Total'); ?></th>
										</tr>
									</thead>
									<tbody>
									<?php 
									// INIT ITEM'S
									$items = $order['items'];
									$firstRound = false;
									$sum = 0;
									
									foreach ($items as $item) {
										$unit_price = (double) $item['price'] + $item['tax'];
									// GET INFOs about PRODUCT
										$prod = new ctrl_product();
										$prod->load((int)$item['product_id']);
									//	echo "<pre>" . print_r($prod->data, true) . "</pre>";
									//	echo "<pre>" . print_r($item, true) . "</pre>";
									
									// SHORT_DESC Translation
										$short_desciption = (isset($prod->data['short_description'][$_SESSION['language']['code']])) ? $prod->data['short_description'][$_SESSION['language']['code']] : "Failure while loading translation!";
									// TOTAL pP
										$total = 0;// reset
										$total = $unit_price * (int) $item['quantity'];
									// SUBTOTAL
										$sum += $total;
									
									?>
										<tr>
											<td><?php echo (int) $item['quantity'];?></td>
											<td><?php echo $item['sku'];;?></td>
											<td><?php echo $short_desciption;// SHORT DESCRIPTION ?></td>
											<td><?php echo currency::format($unit_price);?></td>
											<td><?php echo currency::format($total);?></td>
										</tr>
									<?php 
										$prod = NULL;// DESTRUCT
									}?>
										<!-- FINAL -->
										<?php
											$fees = 0;
											// SHIPPING FEEs
											if (isset($order['shipping_fee']) && is_numeric($order['shipping_fee']) && $order['shipping_fee'] != 0) { 
												$fees += $order['shipping_fee'];
										?>
										<tr id="finalArticleOHistory1">
											<td colspan="4"><?php echo language::translate('ot_shipping_fee:title_shipping_fee', 'Shipping Fee');?></td>
											<td><?php echo currency::format($order['shipping_fee']); ?></td>
										</tr>
										<?php
											} // PAYMENT FEEs
											if (isset($order['payment_fee']) && is_numeric($order['payment_fee']) && $order['payment_fee'] != 0) {
												$fees += $order['payment_fee'];
										?>
										<tr id="finalArticleOHistory1">
											<td colspan="4"><?php echo language::translate('ot_payment_fee:title_payment_fee', 'Payment Fee');?></td>
											<td><?php echo currency::format($order['payment_fee']); ?></td>
										</tr>
										<?php
											} // Other FEEs
											if (isset($order['fees']) && is_numeric($order['fees']) && $order['fees'] != 0) {
												$fees += $order['fees'];
										?>
										<tr id="finalArticleOHistory1">
											<td colspan="4"><?php echo language::translate('ot_payment_fee:unknown_fee', 'Unknown Fee');?></td>
											<td><?php echo currency::format($order['fees']); ?></td>
										</tr>
										<?php } ?>
										<tr id="finalArticleOHistory2">
											<td colspan="3"><?php if (isset($orders['tracking_id'])) echo "Shipping Tracking ID " . $orders['tracking_id'];?></td>
											<td><?php echo language::translate('title_subtotal', 'Subtotal');?></td>
											<td><?php echo currency::format(($sum + $fees)); ?></td>
										</tr>
									</tbody>
								</table>
							</details>
						</td>
					</tr>
				]]>
			</add>
		</operation>
	</file>
</modification>